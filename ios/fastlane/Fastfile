# ./ios/fastlane/Fastfile
require 'dotenv/load'

Dotenv.load(
  File.expand_path('../.env', __dir__),
  File.expand_path('../../.env', __dir__)
)

default_platform(:ios)

platform :ios do
  before_all do
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: true
    )
  end

  def bundle_exec(command, gemfile: nil)
    brew_bundle = "/opt/homebrew/opt/ruby/bin/bundle"
    bundle_bin = File.exist?(brew_bundle) ? brew_bundle : "bundle"
    if gemfile
      sh "BUNDLE_GEMFILE=#{gemfile} #{bundle_bin} exec #{command}"
    else
      sh "#{bundle_bin} exec #{command}"
    end
  end

  # --- pubspec.yaml version helpers ---

  def read_pubspec_version(pubspec_path)
    content = File.read(pubspec_path)
    m = content.match(/^version:\s*([0-9]+\.[0-9]+\.[0-9]+)\+([0-9]+)\s*$/)
    UI.user_error!("pubspec.yamlì—ì„œ version ë¼ì¸ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: #{pubspec_path}") unless m
    { name: m[1], build: m[2].to_i }
  end

  def write_pubspec_version(pubspec_path, version_name, build_number)
    content = File.read(pubspec_path)
    new_line = "version: #{version_name}+#{build_number}"
    new_content = content.gsub(/^version:\s*[0-9]+\.[0-9]+\.[0-9]+\+\d+\s*$/, new_line)
    UI.user_error!("pubspec.yaml version ë¼ì¸ ì¹˜í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: #{pubspec_path}") if new_content == content
    File.write(pubspec_path, new_content)
  end

  # TestFlight ìµœì‹  buildì™€ pubspec buildë¥¼ ë¹„êµí•´ì„œ next buildë¥¼ ê²°ì •í•˜ê³  pubspecì„ ê°±ì‹ 
  # ë°˜í™˜: { version_name: "1.0.1", build_number: 40, release_version: "1.0.1+40" }
  def bump_pubspec_build_number!(app_identifier:, project_root:)
    pubspec_path = File.join(project_root, "pubspec.yaml")
    current = read_pubspec_version(pubspec_path)

    latest_build = 0
    begin
      latest_build = latest_testflight_build_number(app_identifier: app_identifier).to_i
    rescue => e
      UI.message("latest_testflight_build_number ì¡°íšŒ ì‹¤íŒ¨(ì´ˆê¸° ë°°í¬ì¼ ìˆ˜ ìˆìŒ): #{e.message}")
      latest_build = 0
    end

    next_build = [latest_build, current[:build]].max + 1

    UI.message("pubspec current: #{current[:name]}+#{current[:build]}")
    UI.message("testflight latest: #{latest_build}")
    UI.message("next build number: #{next_build}")

    write_pubspec_version(pubspec_path, current[:name], next_build)

    {
      version_name: current[:name],
      build_number: next_build,
      release_version: "#{current[:name]}+#{next_build}"
    }
  end

  def ensure_pods_installed!(project_root)
    ios_gemfile = File.join(project_root, "ios", "Gemfile")
    Dir.chdir(File.join(project_root, "ios")) do
      bundle_exec "pod --version", gemfile: ios_gemfile
      bundle_exec "pod install", gemfile: ios_gemfile
    end
  end

  def find_latest_ipa(project_root)
    ipa = Dir.glob("#{project_root}/build/ios/**/*.ipa").max_by { |f| File.mtime(f) }
    UI.user_error!("IPA íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¹Œë“œê°€ ì„±ê³µí–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.") unless ipa
    ipa
  end

  # -------------------------
  # Lane 1) Flutter ë¹Œë“œ -> TestFlight
  # -------------------------
  desc "Flutter ì•±ì„ ë¹Œë“œí•˜ê³  TestFlightì— ë°°í¬í•©ë‹ˆë‹¤. (pubspec build ìë™ ì¦ê°€)"
  lane :deploy_to_testflight do
    app_identifier = ENV["APP_IDENTIFIER"] || "com.newdawn.soi-project"
    project_root = File.expand_path("../..", __dir__)
    ios_gemfile = File.join(project_root, "ios", "Gemfile")

    bumped = bump_pubspec_build_number!(app_identifier: app_identifier, project_root: project_root)
    UI.message("âœ… Using version: #{bumped[:release_version]}")

    ensure_pods_installed!(project_root)

    Dir.chdir(project_root) do
      bundle_exec "flutter pub get", gemfile: ios_gemfile
      # pubspec ë²„ì „ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì˜¤ë²„ë¼ì´ë“œ X) -> iOS/ASC/shorebirdì™€ ì¼ì¹˜ ë³´ì¥
      bundle_exec "flutter build ipa --release", gemfile: ios_gemfile
    end

    ipa_path = find_latest_ipa(project_root)
    UI.message("IPA: #{ipa_path}")

    pilot(
      ipa: ipa_path,
      app_identifier: app_identifier,
      skip_waiting_for_build_processing: true,
      changelog: "ì´ë²ˆ ë²„ì „ì˜ í…ŒìŠ¤íŠ¸ ë³€ê²½ ì‚¬í•­ì…ë‹ˆë‹¤.",
      distribute_external: false,
      uses_non_exempt_encryption: false
    )
  end

  # -------------------------
  # Lane 2) Shorebird release -> TestFlight
  # -------------------------
  desc "Shorebirdë¡œ ë¹Œë“œí•˜ê³  App Store Connect(TestFlight)ì— ì—…ë¡œë“œí•©ë‹ˆë‹¤. (pubspec build ìë™ ì¦ê°€ + ë²„ì „ ì¼ì¹˜ ë³´ì¥)"
  lane :upload_shorebird do
    app_identifier = ENV["APP_IDENTIFIER"] || "com.newdawn.soi-project"
    project_root = File.expand_path("../..", __dir__)
    ios_gemfile = File.join(project_root, "ios", "Gemfile")

    bumped = bump_pubspec_build_number!(app_identifier: app_identifier, project_root: project_root)
    UI.message("âœ… Using version: #{bumped[:release_version]}")

    ensure_pods_installed!(project_root)

    Dir.chdir(project_root) do
      bundle_exec "flutter pub get", gemfile: ios_gemfile

      UI.message("ğŸ¦ Shorebirdë¡œ iOS ë¹Œë“œ ì‹œì‘...")
      begin
        sh "shorebird release ios"
      rescue FastlaneCore::Interface::FastlaneShellError => e
        # ë™ì¼ ë¦´ë¦¬ì¦ˆê°€ ì´ë¯¸ Shorebirdì— ìˆëŠ” ê²½ìš°ë¥¼ ì•ˆì „í•˜ê²Œ í•œ ë²ˆ ë” ì²˜ë¦¬
        if e.message.include?("existing ios release for version")
          UI.message("âš ï¸ Shorebirdì— ë™ì¼ ë¦´ë¦¬ì¦ˆê°€ ì´ë¯¸ ì¡´ì¬í•˜ì—¬ buildë¥¼ í•œ ë²ˆ ë” ì˜¬ë¦½ë‹ˆë‹¤.")
          # pubspec build +1 í›„ ì¬ì‹œë„
          current = read_pubspec_version(File.join(project_root, "pubspec.yaml"))
          write_pubspec_version(File.join(project_root, "pubspec.yaml"), current[:name], current[:build] + 1)
          UI.message("ğŸ” Retrying with version: #{current[:name]}+#{current[:build] + 1}")
          sh "shorebird release ios"
        else
          raise
        end
      end
    end

    UI.success("âœ… Shorebird ë¹Œë“œ ì™„ë£Œ!")

    ipa_path = find_latest_ipa(project_root)
    UI.success("âœ… IPA íŒŒì¼: #{ipa_path}")

    file_size_mb = File.size(ipa_path) / (1024.0 * 1024.0)
    UI.message("ğŸ“¦ IPA í¬ê¸°: #{file_size_mb.round(1)} MB")

    UI.message("ğŸš€ App Store Connect ì—…ë¡œë“œ ì‹œì‘...")

    pilot(
      ipa: ipa_path,
      app_identifier: app_identifier,
      skip_waiting_for_build_processing: true,
      changelog: "Shorebirdë¡œ ë°°í¬ëœ ë²„ì „ì…ë‹ˆë‹¤.",
      distribute_external: false,
      uses_non_exempt_encryption: false
    )

    UI.success("âœ… ëª¨ë“  ì‘ì—… ì™„ë£Œ!")
  end
end
